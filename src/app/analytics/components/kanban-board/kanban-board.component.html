<div class="kanban-board-container">
  <div *ngIf="loading" class="loading-kanban">
    <span class="material-icons spin">autorenew</span>
    <p>{{ translationPrefix + '.loading' | translate }}</p>
  </div>

  <div *ngIf="!loading" class="kanban-board">
    <div *ngFor="let column of columns" class="kanban-column">
      <div class="column-header" [style.background-color]="column.color">
        <span class="material-icons column-icon">{{ column.icon }}</span>
        <!-- changed: use localized column title -->
        <h3 class="column-title">{{ columnTitle(column) }}</h3>
        <span class="task-count">{{ column.tasks.length }}</span>
      </div>

      <div class="column-content">
        <div *ngIf="column.tasks.length === 0" class="empty-column">
          <span class="material-icons empty-icon">inbox</span>
          <p>{{ translationPrefix + '.noTasks' | translate }}</p>
        </div>

        <div *ngFor="let task of column.tasks" class="task-card" (click)="openTaskDetails(task)">
          <div class="task-header">
            <h4 class="task-title">{{ task.title }}</h4>
            <span class="material-icons task-menu">more_vert</span>
          </div>

          <p class="task-description">{{ task.description }}</p>

          <div class="task-footer">
            <div class="task-footer-left">
              <div class="task-date">
                <span class="material-icons date-icon">event</span>
                <span>{{ formatDate(task.dueDate) }}</span>
              </div>

              <div class="task-rearranged" *ngIf="task.timesRearranged && task.timesRearranged > 0">
                <span class="material-icons">sync</span>
                <span>{{ task.timesRearranged }}</span>
              </div>
            </div>

            <div class="task-member" *ngIf="task.member">
              <img
                *ngIf="task.member.urlImage"
                [src]="task.member.urlImage"
                [alt]="task.member.name"
                class="task-member-avatar"
                [title]="task.member.name + ' ' + task.member.surname">
              <span
                *ngIf="!task.member.urlImage"
                class="material-icons task-member-icon"
                [title]="task.member.name + ' ' + task.member.surname">
                account_circle
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Task details dialog (visible while loading or when selectedTask is available) -->
<div class="task-dialog-overlay" *ngIf="selectedTask || isDialogLoading" (click)="closeTaskDetails()">
  <div class="task-dialog" (click)="$event.stopPropagation()">
    <!-- Render loaded task when available -->
    <ng-container *ngIf="selectedTask as st; else dialogLoading">
      <header class="task-dialog-header">
        <div class="dialog-header-left">
          <div class="dialog-avatar" *ngIf="st.member?.urlImage; else noAvatar">
            <img [src]="st.member?.urlImage" [alt]="st.member?.name">
          </div>
          <ng-template #noAvatar>
            <div class="dialog-avatar dialog-avatar-fallback">
              <span class="material-icons">assignment</span>
            </div>
          </ng-template>

          <div class="dialog-title-block">
            <h3>{{ st.title }}</h3>
            <div class="dialog-subtitle">
              <small>{{ translationPrefix + '.kanban.dialog.id' | translate }}: {{ st.id }}</small>
              <small *ngIf="st.groupId"> â€¢ {{ translationPrefix + '.kanban.dialog.group' | translate }}: {{ st.groupId }}</small>
            </div>
          </div>
        </div>

        <div class="dialog-actions">
          <button class="dialog-close" aria-label="Close" (click)="closeTaskDetails()">&times;</button>
        </div>
      </header>

      <section class="task-dialog-body">
        <p class="dialog-label"><strong>{{ translationPrefix + '.kanban.dialog.description' | translate }}:</strong></p>
        <p class="dialog-text">{{ st.description || (translationPrefix + '.kanban.dialog.noDescription' | translate) }}</p>

        <div class="dialog-meta-grid">
          <div class="meta-item">
            <label>{{ translationPrefix + '.kanban.dialog.dueDate' | translate }}</label>
            <div>{{ formatDate(st.dueDate) }}</div>
          </div>

          <div class="meta-item" *ngIf="st.createdAt">
            <label>{{ translationPrefix + '.kanban.dialog.createdAt' | translate }}</label>
            <div>{{ formatDate(st.createdAt) }}</div>
          </div>

          <div class="meta-item" *ngIf="st.updatedAt">
            <label>{{ translationPrefix + '.kanban.dialog.updatedAt' | translate }}</label>
            <div>{{ formatDate(st.updatedAt) }}</div>
          </div>

          <div class="meta-item">
            <label>{{ translationPrefix + '.kanban.dialog.status' | translate }}</label>
            <div class="status-chip">{{ st.status }}</div>
          </div>

          <div class="meta-item" *ngIf="st.timesRearranged !== undefined">
            <label>{{ translationPrefix + '.kanban.dialog.rearranged' | translate }}</label>
            <div>{{ st.timesRearranged }}</div>
          </div>

          <div class="meta-item" *ngIf="st.timePassed !== undefined">
            <label>{{ translationPrefix + '.kanban.dialog.timePassed' | translate }}</label>
            <div>{{ st.timePassed }} {{ translationPrefix + '.kanban.dialog.timeUnit' | translate }}</div>
          </div>
        </div>

        <div *ngIf="st.member" class="dialog-member">
          <p class="dialog-label"><strong>{{ translationPrefix + '.kanban.dialog.assignedTo' | translate }}:</strong></p>
          <div class="member-info">
            <img *ngIf="st.member?.urlImage" [src]="st.member.urlImage" class="member-avatar" [alt]="st.member.name">
            <div class="member-name">{{ st.member?.name }} {{ st.member?.surname }}</div>
          </div>
        </div>
      </section>

      <footer class="task-dialog-footer">
        <button class="btn" (click)="closeTaskDetails()">{{ translationPrefix + '.kanban.dialog.close' | translate }}</button>
      </footer>
    </ng-container>

    <!-- Loading fallback while fetching details -->
    <ng-template #dialogLoading>
      <header class="task-dialog-header">
        <div class="dialog-header-left">
          <div class="dialog-avatar dialog-avatar-fallback">
            <span class="material-icons">assignment</span>
          </div>
          <div class="dialog-title-block">
            <h3>{{ translationPrefix + '.kanban.dialog.loading' | translate }}</h3>
          </div>
        </div>
        <div class="dialog-actions">
          <button class="dialog-close" aria-label="Close" (click)="closeTaskDetails()">&times;</button>
        </div>
      </header>

      <section class="task-dialog-body">
        <div class="dialog-loading">
          <span class="material-icons spin">autorenew</span>
          <p>{{ translationPrefix + '.kanban.dialog.loading' | translate }}</p>
        </div>
      </section>

      <footer class="task-dialog-footer">
        <button class="btn" (click)="closeTaskDetails()">{{ translationPrefix + '.kanban.dialog.close' | translate }}</button>
      </footer>
    </ng-template>
  </div>
</div>
